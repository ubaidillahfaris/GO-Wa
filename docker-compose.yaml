version: '3.8'

services:
  # MongoDB Database
  mongo:
    container_name: mongo-wa
    image: mongo:7.0
    restart: unless-stopped
    ports:
      - "${MONGO_PORT:-27017}:27017"
    volumes:
      - mongo-data:/data/db
      - mongo-config:/data/configdb
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_USER:-root}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_PASS:-password}
      MONGO_INITDB_DATABASE: ${MONGO_DB:-qr_db}
    networks:
      - app-wa
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # WhatsApp API Application
  app:
    container_name: app-wa
    build:
      context: .
      dockerfile: Dockerfile
    restart: unless-stopped
    ports:
      - "${PORT:-3000}:3000"
    volumes:
      # Persist WhatsApp sessions
      - whatsapp-stores:/app/stores
      # Persist uploaded files
      - whatsapp-uploads:/app/uploads
      # Persist RSA keys
      - app-keys:/app/keys
      # Mount .env file (optional, can use environment instead)
      - ./.env:/app/.env:ro
    environment:
      # Server
      PORT: ${PORT:-3000}
      ENVIRONMENT: ${ENVIRONMENT:-production}

      # MongoDB
      MONGO_USER: ${MONGO_USER:-root}
      MONGO_PASS: ${MONGO_PASS:-password}
      MONGO_HOST: mongo:27017
      MONGO_DB: ${MONGO_DB:-qr_db}

      # JWT
      JWT_SECRET: ${JWT_SECRET:-changeme-in-production}
      JWT_EXPIRES_MIN: ${JWT_EXPIRES_MIN:-60}

      # WhatsApp
      WHATSAPP_STORES_DIR: ${WHATSAPP_STORES_DIR:-./stores}
      WHATSAPP_UPLOADS_DIR: ${WHATSAPP_UPLOADS_DIR:-./uploads/whatsapp}
      WHATSAPP_MAX_CONCURRENCY: ${WHATSAPP_MAX_CONCURRENCY:-10}

      # CORS
      CORS_ALLOWED_ORIGIN: ${CORS_ALLOWED_ORIGIN:-http://localhost:5173}
      CORS_MAX_AGE: ${CORS_MAX_AGE:-43200}
    networks:
      - app-wa
    depends_on:
      mongo:
        condition: service_healthy

  # Nginx Reverse Proxy (optional)
  web:
    container_name: web-wa
    image: nginx:alpine
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - nginx-logs:/var/log/nginx
    networks:
      - app-wa
    depends_on:
      - app

volumes:
  # MongoDB data persistence
  mongo-data:
    driver: local
  mongo-config:
    driver: local

  # WhatsApp data persistence
  whatsapp-stores:
    driver: local
  whatsapp-uploads:
    driver: local

  # App data
  app-keys:
    driver: local

  # Nginx logs
  nginx-logs:
    driver: local

networks:
  app-wa:
    driver: bridge
